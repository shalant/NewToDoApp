@page "/todolist"
@using NewToDoApp.Models
@inject NavigationManager NavigationManager
@inject IToDoService _toDoService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode @(new InteractiveAutoRenderMode(prerender: false))

<MudPopoverProvider />
<MudDialogProvider />

<div class="container">
    @if(isLoading)
    {
        <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" />
        <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" />
        <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="800px" Height="410px" />
    }
    else if (_toDoService.ToDos == null || _toDoService.ToDos.Count == 0)
    {
        <p>Sorry, there are no @taskViewState tasks</p>
        @* <p>Loading...</p> *@
        @* <p>@taskViewState</p> *@
    }
    else
    {
        <div class="home-page">
            <div class="row">
                <div class="col-md-7 col-sm-6">
                    <h3>@Header: @_toDoService.ToDos.Count</h3>
                    @* <p>taskViewState</p> *@
                </div>
                <div class="col-md-5 col-sm-6" >
                    @if (taskViewState == "active")
                    {
                        <div class="mb-3 d-flex">
                            <h5 class="me-2 mt-2">View: </h5>
                            <MudButton OnClick="SetTasksToCompleted" Variant="Variant.Filled" Color="Color.Dark" class="me-3">Completed Tasks</MudButton>
                            <MudButton OnClick="SetTasksToAll" Variant="Variant.Filled" Color="Color.Dark">All Tasks</MudButton>
                        </div>
                    }
                    else if (taskViewState == "completed")
                    {
                        <div class="mb-3 d-flex">
                            <h5 class="me-2 mt-2">View: </h5>
                            <MudButton OnClick="SetTasksToActive" Variant="Variant.Filled" Color="Color.Dark" class="me-3">Active Tasks</MudButton>
                            <MudButton OnClick="SetTasksToAll" Variant="Variant.Filled" Color="Color.Dark">All Tasks</MudButton>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3 d-flex">
                            <h5 class="me-2 mt-2">View: </h5>
                            <MudButton OnClick="SetTasksToActive" Variant="Variant.Filled" Color="Color.Dark" class="me-3">Active Tasks</MudButton>
                            <MudButton OnClick="SetTasksToCompleted" Variant="Variant.Filled" Color="Color.Dark">Completed Tasks</MudButton>
                        </div>
                    }
                </div>
            </div>

            <div class="mb-3">
                <MudButton Href="todolist/create" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary">Create</MudButton>
                @if(taskViewState == "completed")
                {
                    <MudButton @onclick="() => DeleteAll()" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error">Delete all</MudButton>
                }
            </div>
            <MudDataGrid T="TodoItem" Items="_toDoService.ToDos" SelectOnRowClick="true"
            EditMode="DataGridEditMode.Form" Bordered="true" Elevation="15"
            EditTrigger="DataGridEditTrigger.OnRowClick">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="Id" />
                    <PropertyColumn Property="x => x.Name" Title="Name" />
                    <TemplateColumn Items="todoitem" title="Completed">
                        <CellTemplate>
                            <MudCheckBox @bind-Value="@context.Item.IsComplete" @onclick="() => ChangeCompleteness(context.Item)"></MudCheckBox>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Items="todoitem">
                        <CellTemplate>
                            @* OnClick="(() => Edit(context.Item.ID))" *@
                            
                            <MudIconButton @onclick="OpenDeleteDialog" Icon="@Icons.Material.Filled.Info" Color="Color.Primary" aria-label="delete" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Success" aria-label="delete" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" aria-label="delete" />

                            @* I WANT TO USE THIS ONE... *@
                            @* <a href="@($"todoitem/details/{context.Item.Id}")"><i class="fa-solid fa-circle-info fa-xl"></i></a>
                            <a href="@($"todoitem/update/{context.Item.Id}")"><i class="fa-solid fa-pen-to-square fa-xl"></i></a> *@
                            @* <a @onclick="() => DeleteTodoItem(context.Item.Id)" href="@($"todoitem/delete/{context.Item.Id}")"><i class="fa-solid fa-trash fa-xl"></i></a> *@

                            @* <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" /> *@
                            @* <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Details"
                            OnClick="() => GoToDeletePage(3)" />
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" />
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" /> *@

                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </div>
    }
</div>

@code {
    public List<TodoItem> ToDoListTrad = new List<TodoItem>();
    public string taskViewState = "active";
    public bool activeTasks = true;
    public string Header = "Active Tasks";
    public bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {        
        _toDoService.ToDosChanged += StateHasChanged;
        _toDoService.ToDos = await _toDoService.GetActiveTodos();
        LoadState();
        isLoading = false;
    }

    // protected override async Task OnParametersSetAsync()
    // {
    //     _toDoService.ToDosChanged += StateHasChanged;
    // }

    private async void LoadState()
    {
        if(taskViewState == "completed")
        {
            // _toDoService.ToDos = _toDoService.ToDos.Where(x => x.IsComplete == true).ToList();
            _toDoService.ToDos = await _toDoService.GetCompletedTodos();
        }
        else if (taskViewState == "active")
        {
            // _toDoService.ToDos = _toDoService.ToDos.Where(x => x.IsComplete == false).ToList();
            _toDoService.ToDos = await _toDoService.GetActiveTodos();
        }
        else 
        {
            _toDoService.ToDos = await _toDoService.GetAllToDos();
        }
        StateHasChanged();
    }


    private void SetTasksToCompleted()
    {
        taskViewState = "completed";
        Header = "All Completed Tasks";
        LoadState();
        _toDoService.ToDosChanged += StateHasChanged;
    }

    private void SetTasksToAll()
    {
        taskViewState = "all";
        Header = "All Tasks";
        LoadState();
        _toDoService.ToDosChanged += StateHasChanged;
    }

    private void SetTasksToActive()
    {
        taskViewState = "active";
        Header = "All Active Tasks";
        LoadState();
        _toDoService.ToDosChanged += StateHasChanged;
    }

    private async Task ChangeCompleteness(TodoItem itemToUpdate)
    {
        itemToUpdate.IsComplete = !itemToUpdate.IsComplete;
        await _toDoService.UpdateTodoItem(itemToUpdate);
        LoadState();
        _toDoService.ToDosChanged += StateHasChanged;
    }

    private Task OpenDeleteDialog() 
    {
        var parameters = new DialogParameters<DialogTemplateExample_Dialog>
        {
            { x => x.ContentText, "Do you really want to delete these records? This process cannot be undone." },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        return DialogService.ShowAsync<DialogTemplateExample_Dialog>("Delete", parameters, options);
    }

    private async Task DeleteTodoItem(int id)
    {

        await _toDoService.DeleteTodo(id);
    }

    private async Task DeleteAll()
    {
        await _toDoService.DeleteAllCompleted();
        LoadState();
        _toDoService.ToDosChanged += StateHasChanged;
    }

    private void GoToDeletePage(int id){
        NavigationManager.NavigateTo($"todoitem/delete/{id}");
    }


}
